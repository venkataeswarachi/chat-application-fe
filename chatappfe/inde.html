<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Spring Boot WebSocket Chat</title>
</head>
<body>
<h2>Real-time Chat</h2>

<input type="text" id="username" placeholder="Enter your name" />
<button id="connect">Connect</button>
<button id="disconnect" disabled>Disconnect</button>
<br><br>

<div id="chat" style="display:none;">
    <div id="messages" style="border:1px solid #ccc;height:300px;overflow:auto;"></div>
    <input type="text" id="message" placeholder="Type a message..." />
    <button id="send">Send</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<script>
    let stompClient = null;

    function setConnected(connected) {
        document.getElementById("connect").disabled = connected;
        document.getElementById("disconnect").disabled = !connected;
        document.getElementById("chat").style.display = connected ? "block" : "none";
    }

    document.getElementById("connect").onclick = () => {
        const username = document.getElementById("username").value.trim();
        if (!username) { alert("Enter your name"); return; }

        const socket = new SockJS('http://localhost:8090/ws');
        console.log("first");
        stompClient = Stomp.over(socket);
        stompClient.connect({}, (frame) => {
            setConnected(true);
            console.log("Connected: " + frame);

            stompClient.subscribe('/topic/room', (msg) => {
                const message = JSON.parse(msg.body);
                showMessage(message);
            });
            console.log("second");
            stompClient.send("/app/addUser", {}, JSON.stringify({sender: username, type: 'JOIN'}));
        });
    };

    document.getElementById("disconnect").onclick = () => {
        if (stompClient) stompClient.disconnect();
        setConnected(false);
        console.log("Disconnected");
    };

    document.getElementById("send").onclick = () => {
        const message = document.getElementById("message").value;
        const username = document.getElementById("username").value;
        if (!message) return;

        stompClient.send("/app/sendMessage", {}, JSON.stringify({
            sender: username,
            content: message,
            type: 'CHAT'
        }));
        document.getElementById("message").value = "";
    };

    function showMessage(msg) {
        const messagesDiv = document.getElementById("messages");
        const div = document.createElement("div");
        if (msg.type === "JOIN") {
            div.innerHTML = `<em>${msg.sender} joined the chat</em>`;
        } else {
            div.innerHTML = `<b>${msg.sender}:</b> ${msg.content}`;
        }
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
</script>
</body>
</html>
